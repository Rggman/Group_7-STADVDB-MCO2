<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distributed Database Simulator</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>üóÑÔ∏è Distributed Database Simulator</h1>
      <p>Multi-Node Concurrency Control & Replication Management</p>
    </header>

    <!-- Notification Area -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- Main Dashboard -->
    <main class="dashboard">
      
      <!-- Left Sidebar: Node Management -->
      <section class="sidebar">
        <div class="section-card">
          <h2>üìä Node Status</h2>
          
          <div class="nodes-grid">
            <div class="node-card master">
              <div id="status-node0" class="node-status offline">NODE 0: OFFLINE</div>
              <p class="node-role">Master / Central</p>
              <p class="node-data">Full Dataset</p>
              <div class="node-buttons">
                <button onclick="killNode('node0')" class="btn-small danger">Kill</button>
                <button onclick="recoverNode('node0')" class="btn-small success">Recover</button>
                <button onclick="viewData('node0')" class="btn-small info">View Data</button>
              </div>
            </div>

            <div class="node-card fragment">
              <div id="status-node1" class="node-status offline">NODE 1: OFFLINE</div>
              <p class="node-role">Fragment A</p>
              <p class="node-data">First Half Rows</p>
              <div class="node-buttons">
                <button onclick="killNode('node1')" class="btn-small danger">Kill</button>
                <button onclick="recoverNode('node1')" class="btn-small success">Recover</button>
                <button onclick="viewData('node1')" class="btn-small info">View Data</button>
              </div>
            </div>

            <div class="node-card fragment">
              <div id="status-node2" class="node-status offline">NODE 2: OFFLINE</div>
              <p class="node-role">Fragment B</p>
              <p class="node-data">Second Half Rows</p>
              <div class="node-buttons">
                <button onclick="killNode('node2')" class="btn-small danger">Kill</button>
                <button onclick="recoverNode('node2')" class="btn-small success">Recover</button>
                <button onclick="viewData('node2')" class="btn-small info">View Data</button>
              </div>
            </div>
          </div>
        </div>

        <div class="section-card">
          <h2>‚öôÔ∏è Control Panel</h2>
          <button onclick="app.initializeApp()" class="btn-full primary">Reinitialize Backend</button>
          <button onclick="app.startAutoRefresh()" class="btn-full secondary">Start Auto-Refresh</button>
          <button onclick="app.stopAutoRefresh()" class="btn-full secondary">Stop Auto-Refresh</button>
          <button onclick="app.clearLogsAction()" class="btn-full danger">Clear All Logs</button>
        </div>
      </section>

      <!-- Center: Query Execution -->
      <section class="main-content">
        <div class="section-card">
          <h2>üíæ Execute Query</h2>
          
          <div class="form-group">
            <label>Target Node</label>
            <select id="selectNode" onchange="updateSelectedNode(this.value)">
              <option value="node0">Node 0 (Master)</option>
              <option value="node1">Node 1 (Fragment A)</option>
              <option value="node2">Node 2 (Fragment B)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Isolation Level</label>
            <select id="isolationLevel" onchange="updateIsolationLevel(this.value)">
              <option value="READ_UNCOMMITTED">Read Uncommitted</option>
              <option value="READ_COMMITTED" selected>Read Committed</option>
              <option value="REPEATABLE_READ">Repeatable Read</option>
              <option value="SERIALIZABLE">Serializable</option>
            </select>
          </div>

          <div class="form-group">
            <label>SQL Query</label>
            <textarea id="queryInput" placeholder="Enter SQL query here..." rows="6"></textarea>
          </div>

          <button onclick="executeQuery()" class="btn-full primary">Execute Query</button>
        </div>

        <!-- Transaction Logs -->
        <div class="section-card">
          <h2>üìù Recent Transactions (Last 10)</h2>
          <div id="transaction-logs" class="logs-container">
            <div class="log-entry">No transactions yet</div>
          </div>
        </div>
      </section>

      <!-- Right Sidebar: Replication & Status -->
      <section class="sidebar">
        <div class="section-card">
          <h2>üîÑ Replication Queue</h2>
          <div id="replication-queue" class="logs-container">
            <div class="queue-entry">Queue is empty</div>
          </div>
          <button onclick="retryReplication()" class="btn-full success" style="margin-top: 10px;">Retry Replication</button>
        </div>

        <div class="section-card">
          <h2>üß™ Test Cases</h2>
          <button onclick="openCase1Modal()" class="btn-full info">Case 1: Concurrent Reads</button>
          <button onclick="openCase2Modal()" class="btn-full info">Case 2: Write + Reads</button>
          <button onclick="runTestCase('case3')" class="btn-full info">Case 3: Concurrent Writes</button>
          <button onclick="runTestCase('failure1')" class="btn-full warning">Failure 1: Replication Fail</button>
          <button onclick="runTestCase('failure2')" class="btn-full warning">Failure 2: Node0 Recovery</button>
        </div>
      </section>

    </main>

    <!-- Data Viewer Modal -->
    <div id="dataModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeDataModal()">&times;</span>
        <h2 id="dataModalTitle">Node Data</h2>
        <div id="dataTable" class="data-table"></div>
      </div>
    </div>

    <!-- Case 1 Modal -->
    <div id="case1Modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeCase1Modal()">&times;</span>
        <h2>Case 1: Concurrent Reads</h2>
        <div class="form-group">
          <label>Node A</label>
          <select id="case1NodeA">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Node B</label>
          <select id="case1NodeB">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Record ID</label>
          <input id="case1RecordId" type="number" placeholder="e.g. 1" />
        </div>
        <div class="form-group">
          <label>Isolation Level</label>
          <select id="case1Isolation">
            <option value="READ_UNCOMMITTED">Read Uncommitted</option>
            <option value="READ_COMMITTED" selected>Read Committed</option>
            <option value="REPEATABLE_READ">Repeatable Read</option>
            <option value="SERIALIZABLE">Serializable</option>
          </select>
        </div>
        <button onclick="runCase1()" class="btn-full primary">Run Concurrent Reads</button>
        <div id="case1Output" class="logs-container" style="margin-top:10px;"></div>
      </div>
    </div>
    <!-- Case 2 Modal -->
    <div id="case2Modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeCase2Modal()">&times;</span>
        <h2>Case 2: Write + Reads</h2>
        <div class="form-group">
          <label>Writer Node</label>
          <select id="case2Writer">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reader Node A</label>
          <select id="case2ReaderA">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reader Node B</label>
          <select id="case2ReaderB">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Record ID</label>
          <input id="case2RecordId" type="number" placeholder="e.g. 1" />
        </div>
        <div class="form-group">
          <label>New Amount Value</label>
          <input id="case2NewValue" type="number" placeholder="e.g. 500" />
        </div>
        <div class="form-group">
          <label>Isolation Level (Write & Reads)</label>
          <select id="case2Isolation">
            <option value="READ_UNCOMMITTED">Read Uncommitted</option>
            <option value="READ_COMMITTED" selected>Read Committed</option>
            <option value="REPEATABLE_READ">Repeatable Read</option>
            <option value="SERIALIZABLE">Serializable</option>
          </select>
        </div>
        <button onclick="runCase2()" class="btn-full primary">Run Write + Concurrent Reads</button>
        <div id="case2Output" class="logs-container" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as app from './src/app.js';
    import { case1ConcurrentReads, case2WritePlusReads, retryReplication } from './src/test-cases.js';
    
    // Make app functions globally accessible
    window.app = app;
    
    // Initialize application
    app.initializeApp();

    // UI Event Handlers
    window.updateSelectedNode = function(node) {
      app.setState({ selectedNode: node });
    };

    window.updateIsolationLevel = function(level) {
      app.setState({ selectedIsolationLevel: level });
    };

    window.executeQuery = async function() {
      const queryInput = document.getElementById('queryInput');
      const query = queryInput.value;
      await app.executeQueryAction(query);
      queryInput.value = '';
    };

    window.killNode = async function(node) {
      if (confirm(`Are you sure you want to kill ${node}?`)) {
        await app.killNodeAction(node);
      }
    };

    window.recoverNode = async function(node) {
      await app.recoverNodeAction(node);
    };

    window.viewData = async function(node) {
      const data = await app.viewNodeData(node);
      if (data) {
        showDataModal(node, data);
      }
    };

    window.retryReplication = function() { retryReplication(); };

    // Case 1 Modal controls
    window.openCase1Modal = function(){
      document.getElementById('case1Modal').style.display = 'block';
    };
    window.closeCase1Modal = function(){
      document.getElementById('case1Modal').style.display = 'none';
    };
    window.runCase1 = async function(){
      const nodeA = document.getElementById('case1NodeA').value;
      const nodeB = document.getElementById('case1NodeB').value;
      const recordId = document.getElementById('case1RecordId').value;
      const isolation = document.getElementById('case1Isolation').value;
      const out = document.getElementById('case1Output');
      out.innerHTML = '<div class="log-entry">Running...</div>';
      const res = await case1ConcurrentReads(nodeA, nodeB, recordId, isolation);
      const details = `RowsA: ${res.results?.rowsA} | RowsB: ${res.results?.rowsB} | Same: ${res.results?.same ? 'YES' : 'NO'}`;
      const dataAJson = JSON.stringify(res.results?.dataA || [], null, 2);
      const dataBJson = JSON.stringify(res.results?.dataB || [], null, 2);
      out.innerHTML = `
        <div class="log-entry success">Isolation: ${isolation.replace('_',' ')}</div>
        <div class="log-entry success">Query: ${res.query}</div>
        <div class="log-entry success">NodeA: ${res.results?.nodeA} | NodeB: ${res.results?.nodeB}</div>
        <div class="log-entry">${details}</div>
        <div class="log-entry"><strong>Node A Data</strong></div>
        <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:200px;">${dataAJson}</pre>
        <div class="log-entry"><strong>Node B Data</strong></div>
        <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:200px;">${dataBJson}</pre>
      `;
    };
    // Case 2 controls
    window.openCase2Modal = function(){
      document.getElementById('case2Modal').style.display = 'block';
    };
    window.closeCase2Modal = function(){
      document.getElementById('case2Modal').style.display = 'none';
    };
    window.runCase2 = async function(){
      const writer = document.getElementById('case2Writer').value;
      const readerA = document.getElementById('case2ReaderA').value;
      const readerB = document.getElementById('case2ReaderB').value;
      const recordId = document.getElementById('case2RecordId').value;
      const newValue = document.getElementById('case2NewValue').value;
      const isolation = document.getElementById('case2Isolation').value;
      const out = document.getElementById('case2Output');
      out.innerHTML = '<div class="log-entry">Running...</div>';
      try {
        const res = await case2WritePlusReads(writer, readerA, readerB, recordId, newValue, isolation);
        const writeStatus = res.write?.status || 'FAIL';
        const dataWriterArr = res.reads?.writer || [];
        const dataAArr = res.reads?.readerA || [];
        const dataBArr = res.reads?.readerB || [];
        const equalA = JSON.stringify(dataWriterArr) === JSON.stringify(dataAArr);
        const equalB = JSON.stringify(dataWriterArr) === JSON.stringify(dataBArr);
        const dataWriter = JSON.stringify(dataWriterArr, null, 2);
        const dataA = JSON.stringify(dataAArr, null, 2);
        const dataB = JSON.stringify(dataBArr, null, 2);
        const rep = res.write?.replication || [];
        const repLines = rep.length ? rep.map(r => `Target: ${r.target} | Status: ${r.status}${r.error ? ' | Error: '+r.error : ''}`).join('\n') : 'No replication performed';
        out.innerHTML = `
          <div class="log-entry success">Isolation: ${isolation.replace('_',' ')}</div>
          <div class="log-entry">Write Status: ${writeStatus}</div>
          <div class="log-entry">Record ID: ${recordId} Updated To: ${newValue}</div>
          <div class="log-entry">Consistency vs Reader A: ${equalA ? 'MATCH' : 'DIFF'}</div>
          <div class="log-entry">Consistency vs Reader B: ${equalB ? 'MATCH' : 'DIFF'}</div>
          <div class="log-entry"><strong>Replication Details</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:120px;">${repLines}</pre>
          <div class="log-entry"><strong>Writer Node Data</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:150px;">${dataWriter}</pre>
          <div class="log-entry"><strong>Reader A Data</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:150px;">${dataA}</pre>
          <div class="log-entry"><strong>Reader B Data</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:150px;">${dataB}</pre>
        `;
      } catch (e) {
        out.innerHTML = `<div class=\"log-entry\">Error: ${e.message}</div>`;
      }
    };

    window.showDataModal = function(node, data) {
      const modal = document.getElementById('dataModal');
      const title = document.getElementById('dataModalTitle');
      const tableDiv = document.getElementById('dataTable');
      
      title.textContent = `${node.toUpperCase()} - ${data.count} rows`;
      
      let tableHTML = '<table class="data-table"><tr>';
      
      // Add headers
      if (data.data && data.data.length > 0) {
        const firstRow = data.data[0];
        Object.keys(firstRow).forEach(key => {
          tableHTML += `<th>${key}</th>`;
        });
        tableHTML += '</tr>';
        
        // Add rows
        data.data.forEach(row => {
          tableHTML += '<tr>';
          Object.values(row).forEach(value => {
            tableHTML += `<td>${value}</td>`;
          });
          tableHTML += '</tr>';
        });
      }
      
      tableHTML += '</table>';
      tableDiv.innerHTML = tableHTML;
      modal.style.display = 'block';
    };

    window.closeDataModal = function() {
      document.getElementById('dataModal').style.display = 'none';
    };
  </script>
</body>
</html>
