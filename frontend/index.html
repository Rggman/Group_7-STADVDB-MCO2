<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distributed Database Simulator</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>Distributed Database Simulator</h1>
      <p>Multi-Node Concurrency Control & Replication Management</p>
    </header>

    <!-- Notification Area -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- Main Dashboard -->
    <main class="dashboard">
      
      <!-- Left Sidebar: Node Management -->
      <section class="sidebar">
        <div class="section-card">
          <h2>Node Status</h2>
          
          <div class="nodes-grid">
            <div class="node-card master">
              <div id="status-node0" class="node-status offline">NODE 0: OFFLINE</div>
              <p class="node-role">Master / Central</p>
              <p class="node-data">Full Dataset</p>
              <div class="node-buttons">
                <button onclick="killNode('node0')" class="btn-small danger">Kill</button>
                <button onclick="recoverNode('node0')" class="btn-small success">Recover</button>
                <button onclick="viewData('node0')" class="btn-small info">View Data</button>
              </div>
            </div>

            <div class="node-card fragment">
              <div id="status-node1" class="node-status offline">NODE 1: OFFLINE</div>
              <p class="node-role">Fragment A</p>
              <p class="node-data">First Half Rows</p>
              <div class="node-buttons">
                <button onclick="killNode('node1')" class="btn-small danger">Kill</button>
                <button onclick="recoverNode('node1')" class="btn-small success">Recover</button>
                <button onclick="viewData('node1')" class="btn-small info">View Data</button>
              </div>
            </div>

            <div class="node-card fragment">
              <div id="status-node2" class="node-status offline">NODE 2: OFFLINE</div>
              <p class="node-role">Fragment B</p>
              <p class="node-data">Second Half Rows</p>
              <div class="node-buttons">
                <button onclick="killNode('node2')" class="btn-small danger">Kill</button>
                <button onclick="recoverNode('node2')" class="btn-small success">Recover</button>
                <button onclick="viewData('node2')" class="btn-small info">View Data</button>
              </div>
            </div>
          </div>
        </div>

        <div class="section-card">
          <h2>Control Panel</h2>
          <button onclick="app.startAutoRefresh()" class="btn-full secondary">Start Auto-Refresh</button>
          <button onclick="app.stopAutoRefresh()" class="btn-full secondary">Stop Auto-Refresh</button>
          <button onclick="app.clearLogsAction()" class="btn-full danger">Clear All Logs</button>
        </div>
      </section>

      <!-- Center: Database Operations -->
      <section class="main-content">
        
        <!-- Operation Tabs -->
        <div class="section-card">
          <div class="operation-tabs">
            <button onclick="showOperationTab('insert')" class="tab-btn active" id="insertTab">INSERT</button>
            <button onclick="showOperationTab('update')" class="tab-btn" id="updateTab">UPDATE</button>
            <button onclick="showOperationTab('delete')" class="tab-btn" id="deleteTab">DELETE</button>
            <button onclick="showOperationTab('reports')" class="tab-btn" id="reportsTab">REPORTS</button>
          </div>

          <!-- INSERT Operation -->
          <div id="insertOperation" class="operation-panel active">
            <h2>Insert New Transaction</h2>
            <p class="info-text">Select the target node for execution. Replication will occur automatically based on fragmentation rules.</p>
            
            <div class="form-group">
              <label>Target Node <span class="required">*</span></label>
              <select id="insertTargetNode" class="form-control">
                <option value="node0">Node 0 (Central/Master)</option>
                <option value="node1">Node 1 (Fragment A)</option>
                <option value="node2">Node 2 (Fragment B)</option>
              </select>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Transaction ID <span class="required">*</span></label>
                <input type="number" id="insertTransId" class="form-control" placeholder="e.g., 50001" required>
                <small>Must be unique</small>
              </div>
              <div class="form-group">
                <label>Account ID <span class="required">*</span></label>
                <input type="number" id="insertAccountId" class="form-control" placeholder="e.g., 2378" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Transaction Date <span class="required">*</span></label>
                <input type="date" id="insertDate" class="form-control" required>
                <small>Pre-1997 → Node 1 | 1997+ → Node 2</small>
              </div>
              <div class="form-group">
                <label>Amount <span class="required">*</span></label>
                <input type="number" id="insertAmount" class="form-control" step="0.01" placeholder="e.g., 500.00" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Balance <span class="required">*</span></label>
                <input type="number" id="insertBalance" class="form-control" step="0.01" placeholder="e.g., 1500.00" required>
              </div>
              <div class="form-group">
                <!-- Empty space for layout balance -->
              </div>
            </div>
            
            <button onclick="executeInsert()" class="btn btn-success">Insert Record</button>
            <div id="insertResult" class="operation-result"></div>
          </div>

          <!-- UPDATE Operation -->
          <div id="updateOperation" class="operation-panel">
            <h2>Update Existing Transaction</h2>
            <p class="info-text">Select the target node for execution. Replication will occur automatically based on fragmentation rules.</p>
            
            <div class="form-group">
              <label>Target Node <span class="required">*</span></label>
              <select id="updateTargetNode" class="form-control">
                <option value="node0">Node 0 (Central/Master)</option>
                <option value="node1">Node 1 (Fragment A)</option>
                <option value="node2">Node 2 (Fragment B)</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Transaction ID to Update <span class="required">*</span></label>
              <input type="number" id="updateTransId" class="form-control" placeholder="Enter trans_id" required>
              <button onclick="loadRecordForUpdate()" class="btn-small info" style="margin-top: 5px;">Load Current Values</button>
            </div>
            
            <div id="currentRecordDisplay" class="info-box" style="display:none; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
              <strong>Current Record:</strong>
              <div id="currentRecordDetails"></div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Account ID</label>
                <input type="number" id="updateAccountId" class="form-control" placeholder="Leave blank to keep current">
              </div>
              <div class="form-group">
                <label>Transaction Date</label>
                <input type="date" id="updateDate" class="form-control">
                <small>Changing date may move record to different fragment</small>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Amount</label>
                <input type="number" id="updateAmount" class="form-control" step="0.01" placeholder="Leave blank to keep current">
              </div>
              <div class="form-group">
                <label>Balance</label>
                <input type="number" id="updateBalance" class="form-control" step="0.01" placeholder="Leave blank to keep current">
              </div>
            </div>
            
            <button onclick="executeUpdate()" class="btn btn-primary">Update Record</button>
            <div id="updateResult" class="operation-result"></div>
          </div>

          <!-- DELETE Operation -->
          <div id="deleteOperation" class="operation-panel">
            <h2>Delete Transaction</h2>
            <p class="warning-text">WARNING: Select the target node for execution. Replication will occur automatically. This action cannot be undone.</p>
            
            <div class="form-group">
              <label>Target Node <span class="required">*</span></label>
              <select id="deleteTargetNode" class="form-control">
                <option value="node0">Node 0 (Central/Master)</option>
                <option value="node1">Node 1 (Fragment A)</option>
                <option value="node2">Node 2 (Fragment B)</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Transaction ID to Delete <span class="required">*</span></label>
              <input type="number" id="deleteTransId" class="form-control" placeholder="Enter trans_id" required>
              <button onclick="loadRecordForDelete()" class="btn-small info" style="margin-top: 5px;">Preview Record</button>
            </div>
            
            <div id="deleteRecordDisplay" class="info-box" style="display:none; margin: 10px 0; padding: 10px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger-color);">
              <strong>Record to be Deleted:</strong>
              <div id="deleteRecordDetails"></div>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="deleteConfirm">
                <span style="color: var(--danger-color); font-weight: bold;">I confirm I want to permanently delete this transaction</span>
              </label>
            </div>
            
            <button onclick="executeDelete()" class="btn btn-danger">Delete Record</button>
            <div id="deleteResult" class="operation-result"></div>
          </div>

          <!-- REPORTS Operation -->
          <div id="reportsOperation" class="operation-panel">
            <h2>Transaction Amount Report</h2>
            <p class="info-text">View total transaction amounts comparing pre-1997 vs 1997+ periods.</p>
            
            <button onclick="generateReport()" class="btn btn-warning">Generate Report</button>
            <div id="reportResult" class="operation-result">
              <pre id="reportOutput" style="display:none; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 5px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; font-size: 13px;"></pre>
            </div>
          </div>
        </div>

        <!-- Transaction Logs -->
        <div class="section-card">
          <h2>Recent Transactions (Last 10)</h2>
          <div id="transaction-logs" class="logs-container">
            <div class="log-entry">No transactions yet</div>
          </div>
        </div>
      </section>

      <!-- Right Sidebar: Replication & Status -->
      <section class="sidebar">
        <div class="section-card">
          <h2>Replication Queue</h2>
          <div id="replication-queue" class="logs-container">
            <div class="queue-entry">Queue is empty</div>
          </div>
        </div>

        <div class="section-card">
          <h2>Test Cases</h2>
          <button onclick="openCase1Modal()" class="btn-full info">Case 1: Concurrent Reads</button>
          <button onclick="openCase2Modal()" class="btn-full info">Case 2: Write + Reads</button>
          <button onclick="openCase3Modal()" class="btn-full info">Case 3: Concurrent Writes</button>
          <button onclick="runTestCase('failure1')" class="btn-full warning">Failure 1: Replication Fail</button>
          <button onclick="runTestCase('failure2')" class="btn-full warning">Failure 2: Node0 Recovery</button>
        </div>
      </section>

    </main>

    <!-- Data Viewer Modal -->
    <div id="dataModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeDataModal()">&times;</span>
        <h2 id="dataModalTitle">Node Data</h2>
        
        <!-- Filter Controls -->
        <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
          <label style="min-width: 80px;">Filter:</label>
          <select id="dataFilter" onchange="refreshDataWithFilter()" style="flex: 1;">
            <option value="all">All Records (50 latest)</option>
            <option value="recent_updates">Recently Updated</option>
            <option value="by_trans_id">Specific Trans ID</option>
            <option value="pre_1997">Pre-1997 Records</option>
            <option value="post_1997">Post-1997 Records</option>
            <option value="high_balance">High Balance (>5000)</option>
          </select>
          
          <input id="transIdInput" type="number" placeholder="Trans ID" style="width: 100px; display: none;" onkeypress="if(event.key==='Enter') refreshDataWithFilter()">
          
          <button onclick="refreshDataWithFilter()" class="btn-small primary">Refresh</button>
        </div>
        
        <!-- Status Info -->
        <div id="dataStatus" style="margin-bottom: 10px; font-size: 14px; color: #888;"></div>
        
        <div id="dataTable" class="data-table"></div>
      </div>
    </div>

    <!-- Case 1 Modal -->
    <div id="case1Modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeCase1Modal()">&times;</span>
        <h2>Case 1: Concurrent Reads</h2>
        <div class="form-group">
          <label>Node A</label>
          <select id="case1NodeA">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Node B</label>
          <select id="case1NodeB">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Record ID</label>
          <input id="case1RecordId" type="number" placeholder="e.g. 1" />
        </div>
        <div class="form-group">
          <label>Isolation Level</label>
          <select id="case1Isolation">
            <option value="READ_UNCOMMITTED">Read Uncommitted</option>
            <option value="READ_COMMITTED" selected>Read Committed</option>
            <option value="REPEATABLE_READ">Repeatable Read</option>
            <option value="SERIALIZABLE">Serializable</option>
          </select>
        </div>
        <button onclick="runCase1()" class="btn-full primary">Run Concurrent Reads</button>
        <div id="case1Output" class="logs-container" style="margin-top:10px;"></div>
      </div>
    </div>
    <!-- Case 2 Modal -->
    <div id="case2Modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeCase2Modal()">&times;</span>
        <h2>Case 2: Write + Reads</h2>
        <div class="form-group">
          <label>Writer Node</label>
          <select id="case2Writer">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reader Node A</label>
          <select id="case2ReaderA">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reader Node B</label>
          <select id="case2ReaderB">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Record ID</label>
          <input id="case2RecordId" type="number" placeholder="e.g. 1" />
        </div>
        <div class="form-group">
          <label>New Amount Value</label>
          <input id="case2NewValue" type="number" placeholder="e.g. 500" />
        </div>
        <div class="form-group">
          <label>Isolation Level (Write & Reads)</label>
          <select id="case2Isolation">
            <option value="READ_UNCOMMITTED">Read Uncommitted</option>
            <option value="READ_COMMITTED" selected>Read Committed</option>
            <option value="REPEATABLE_READ">Repeatable Read</option>
            <option value="SERIALIZABLE">Serializable</option>
          </select>
        </div>
        <button onclick="runCase2()" class="btn-full primary">Run Write + Concurrent Reads</button>
        <div id="case2Output" class="logs-container" style="margin-top:10px;"></div>
      </div>
    </div>
    <!-- Case 3 Modal -->
    <div id="case3Modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeCase3Modal()">&times;</span>
        <h2>Case 3: Concurrent Writes (Same Record)</h2>
        <div class="form-group">
          <label>Writer Node A</label>
          <select id="case3NodeA">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Writer Node B</label>
          <select id="case3NodeB">
            <option value="node0">Node 0 (Master)</option>
            <option value="node1">Node 1 (Fragment A)</option>
            <option value="node2">Node 2 (Fragment B)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Record ID</label>
          <input id="case3RecordId" type="number" placeholder="e.g. 1" />
        </div>
        <div class="form-group">
          <label>Amount Value A</label>
          <input id="case3ValueA" type="number" placeholder="e.g. 800" />
        </div>
        <div class="form-group">
          <label>Amount Value B</label>
          <input id="case3ValueB" type="number" placeholder="e.g. 1200" />
        </div>
        <div class="form-group">
          <label>Isolation Level A</label>
          <select id="case3IsoA">
            <option value="READ_UNCOMMITTED">Read Uncommitted</option>
            <option value="READ_COMMITTED" selected>Read Committed</option>
            <option value="REPEATABLE_READ">Repeatable Read</option>
            <option value="SERIALIZABLE">Serializable</option>
          </select>
        </div>
        <div class="form-group">
          <label>Isolation Level B</label>
          <select id="case3IsoB">
            <option value="READ_UNCOMMITTED">Read Uncommitted</option>
            <option value="READ_COMMITTED" selected>Read Committed</option>
            <option value="REPEATABLE_READ">Repeatable Read</option>
            <option value="SERIALIZABLE">Serializable</option>
          </select>
        </div>
        <button onclick="runCase3()" class="btn-full primary">Run Concurrent Writes</button>
        <div id="case3Output" class="logs-container" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as app from './src/app.js';
    import { case1ConcurrentReads, case2WritePlusReads, case3ConcurrentWrites } from './src/test-cases.js';
    import { apiClient } from './src/api.js';
    
    // Make app functions globally accessible
    window.app = app;
    
    // Initialize application
    app.initializeApp();

    // UI Event Handlers
    window.updateSelectedNode = function(node) {
      app.setState({ selectedNode: node });
    };

    window.updateIsolationLevel = function(level) {
      app.setState({ selectedIsolationLevel: level });
    };

    window.executeQuery = async function() {
      const queryInput = document.getElementById('queryInput');
      const query = queryInput.value;
      await app.executeQueryAction(query);
      queryInput.value = '';
    };

    window.killNode = async function(node) {
      if (confirm(`Are you sure you want to kill ${node}?`)) {
        await app.killNodeAction(node);
      }
    };

    window.recoverNode = async function(node) {
      await app.recoverNodeAction(node);
    };

    window.viewData = async function(node) {
      const data = await app.viewNodeData(node);
      if (data) {
        showDataModal(node, data);
      }
    };

    // Case 1 Modal controls
    window.openCase1Modal = function(){
      document.getElementById('case1Modal').style.display = 'block';
    };
    window.closeCase1Modal = function(){
      document.getElementById('case1Modal').style.display = 'none';
    };
    window.runCase1 = async function(){
      const nodeA = document.getElementById('case1NodeA').value;
      const nodeB = document.getElementById('case1NodeB').value;
      const recordId = document.getElementById('case1RecordId').value;
      const isolation = document.getElementById('case1Isolation').value;
      const out = document.getElementById('case1Output');
      out.innerHTML = '<div class="log-entry">Running...</div>';
      const res = await case1ConcurrentReads(nodeA, nodeB, recordId, isolation);
      const details = `RowsA: ${res.results?.rowsA} | RowsB: ${res.results?.rowsB} | Same: ${res.results?.same ? 'YES' : 'NO'}`;
      const dataAJson = JSON.stringify(res.results?.dataA || [], null, 2);
      const dataBJson = JSON.stringify(res.results?.dataB || [], null, 2);
      out.innerHTML = `
        <div class="log-entry success">Isolation: ${isolation.replace('_',' ')}</div>
        <div class="log-entry success">Query: ${res.query}</div>
        <div class="log-entry success">NodeA: ${res.results?.nodeA} | NodeB: ${res.results?.nodeB}</div>
        <div class="log-entry">${details}</div>
        <div class="log-entry"><strong>Node A Data</strong></div>
        <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:200px;">${dataAJson}</pre>
        <div class="log-entry"><strong>Node B Data</strong></div>
        <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:200px;">${dataBJson}</pre>
      `;
    };
    // Case 2 controls
    window.openCase2Modal = function(){
      document.getElementById('case2Modal').style.display = 'block';
    };
    window.closeCase2Modal = function(){
      document.getElementById('case2Modal').style.display = 'none';
    };
    window.runCase2 = async function(){
      const writer = document.getElementById('case2Writer').value;
      const readerA = document.getElementById('case2ReaderA').value;
      const readerB = document.getElementById('case2ReaderB').value;
      const recordId = document.getElementById('case2RecordId').value;
      const newValue = document.getElementById('case2NewValue').value;
      const isolation = document.getElementById('case2Isolation').value;
      const out = document.getElementById('case2Output');
      out.innerHTML = '<div class="log-entry">Running...</div>';
      try {
        const res = await case2WritePlusReads(writer, readerA, readerB, recordId, newValue, isolation);
        const writeStatus = res.write?.status || 'FAIL';
        const dataWriterArr = res.reads?.writer || [];
        const dataAArr = res.reads?.readerA || [];
        const dataBArr = res.reads?.readerB || [];
        const equalA = JSON.stringify(dataWriterArr) === JSON.stringify(dataAArr);
        const equalB = JSON.stringify(dataWriterArr) === JSON.stringify(dataBArr);
        const dataWriter = JSON.stringify(dataWriterArr, null, 2);
        const dataA = JSON.stringify(dataAArr, null, 2);
        const dataB = JSON.stringify(dataBArr, null, 2);
        const rep = res.write?.replication || [];
        const repLines = rep.length ? rep.map(r => `Target: ${r.target} | Status: ${r.status}${r.error ? ' | Error: '+r.error : ''}`).join('\n') : 'No replication performed';
        
        // Concurrency detection
        const concurrency = res.concurrency || {};
        const sawDifferent = concurrency.sawDifferentValues || false;
        const uniqueVals = concurrency.uniqueValues || [];
        const expected = concurrency.expected || '';
        const concurrencyClass = sawDifferent ? 'success' : 'warning';
        const concurrencyMsg = sawDifferent 
          ? `✓ Readers observed different values during concurrent execution (${uniqueVals.join(', ')})`
          : '⚠ All readers observed the same value (may indicate sequential execution or strict locking)';
        
        out.innerHTML = `
          <div class="log-entry success">Isolation: ${isolation.replace('_',' ')}</div>
          <div class="log-entry">Write Status: ${writeStatus}</div>
          <div class="log-entry">Record ID: ${recordId} Updated To: ${newValue}</div>
          <div class="log-entry ${concurrencyClass}"><strong>Concurrency Detection:</strong> ${concurrencyMsg}</div>
          <div class="log-entry">Expected Behavior: ${expected}</div>
          <div class="log-entry">Consistency vs Reader A: ${equalA ? 'MATCH' : 'DIFF'}</div>
          <div class="log-entry">Consistency vs Reader B: ${equalB ? 'MATCH' : 'DIFF'}</div>
          <div class="log-entry"><strong>Replication Details</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:120px;">${repLines}</pre>
          <div class="log-entry"><strong>Writer Node Data</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:150px;">${dataWriter}</pre>
          <div class="log-entry"><strong>Reader A Data</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:150px;">${dataA}</pre>
          <div class="log-entry"><strong>Reader B Data</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:150px;">${dataB}</pre>
        `;
      } catch (e) {
        out.innerHTML = `<div class=\"log-entry\">Error: ${e.message}</div>`;
      }
    };
    // Case 3 controls
    window.openCase3Modal = function(){
      document.getElementById('case3Modal').style.display = 'block';
    };
    window.closeCase3Modal = function(){
      document.getElementById('case3Modal').style.display = 'none';
    };
    window.runCase3 = async function(){
      const nodeA = document.getElementById('case3NodeA').value;
      const nodeB = document.getElementById('case3NodeB').value;
      const recordId = document.getElementById('case3RecordId').value;
      const valueA = document.getElementById('case3ValueA').value;
      const valueB = document.getElementById('case3ValueB').value;
      const isoA = document.getElementById('case3IsoA').value;
      const isoB = document.getElementById('case3IsoB').value;
      const out = document.getElementById('case3Output');
      out.innerHTML = '<div class="log-entry">Running concurrent writes...</div>';
      try {
        const res = await case3ConcurrentWrites(nodeA, nodeB, recordId, valueA, valueB, isoA, isoB);
        const writeLines = res.writes.map(w => `Node: ${w.node} | Status: ${w.status}${w.code ? ' ('+w.code+')' : ''} | ValueSet: ${w.valueSet}${w.error ? ' | Error: '+w.error : ''}`).join('\n');
        const replicationLines = res.writes.map(w => w.replication && w.replication.length ? w.replication.map(r => `  -> Replicate to ${r.target}: ${r.status}${r.error ? ' | '+r.error : ''}`).join('\n') : '  -> No replication').join('\n');
        const orderLine = res.order.map(o => o.node).join(' -> ') || 'Unknown';
        const finalMaster = JSON.stringify(res.finalReads.node0 || [], null, 2);
        const finalA = JSON.stringify(res.finalReads[nodeA] || [], null, 2);
        const finalB = JSON.stringify(res.finalReads[nodeB] || [], null, 2);
        const lockFailures = res.writes.filter(w => w.status === 'failed' && w.code === 423);
        out.innerHTML = `
          <div class="log-entry success">Record ID: ${res.recordId}</div>
          <div class="log-entry">Isolation A: ${isoA.replace('_',' ')} | Isolation B: ${isoB.replace('_',' ')}</div>
          <div class="log-entry">Write Ordering (endTime ascending): ${orderLine}</div>
          <div class="log-entry">Conflict Classification: ${res.conflictType}</div>
          <div class="log-entry">Divergence Across Nodes: ${res.divergence ? 'YES' : 'NO'}</div>
          ${lockFailures.length ? `<div class=\"log-entry warning\"><strong>Lock Enforcement:</strong> ${lockFailures.map(w => `${w.node} blocked: ${w.error}`).join(', ')}</div>` : ''}
          <div class="log-entry"><strong>Writes</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:120px;">${writeLines}\n${replicationLines}</pre>
          <div class="log-entry"><strong>Final Master (node0) Row</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:140px;">${finalMaster}</pre>
          <div class="log-entry"><strong>Final Node A (${nodeA}) Row</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:140px;">${finalA}</pre>
          <div class="log-entry"><strong>Final Node B (${nodeB}) Row</strong></div>
          <pre class="log-entry" style="white-space:pre-wrap;overflow:auto;max-height:140px;">${finalB}</pre>
        `;
      } catch (e) {
        out.innerHTML = `<div class=\"log-entry\">Error: ${e.message}</div>`;
      }
    };

    // Store current modal data globally for filtering
    window.currentModalNode = null;
    window.currentModalData = null;

    window.showDataModal = function(node, data) {
      const modal = document.getElementById('dataModal');
      const title = document.getElementById('dataModalTitle');
      const tableDiv = document.getElementById('dataTable');
      const statusDiv = document.getElementById('dataStatus');
      const filterSelect = document.getElementById('dataFilter');
      const transIdInput = document.getElementById('transIdInput');
      
      // Store for filtering
      window.currentModalNode = node;
      window.currentModalData = data;
      
      // Reset filter to 'all' when opening unless it's a refresh
      if (!data.filter || data.filter === 'all') {
        filterSelect.value = 'all';
        transIdInput.style.display = 'none';
      } else {
        filterSelect.value = data.filter;
        transIdInput.style.display = data.filter === 'by_trans_id' ? 'block' : 'none';
      }
      
      title.textContent = `${node.toUpperCase()} - Data Viewer`;
      
      // Update status info
      const statusText = `${data.count} rows | Filter: ${data.filter || 'all'} | Node: ${node}`;
      const recentInfo = data.recent_updates_available ? ' | Recent updates available' : '';
      statusDiv.innerHTML = statusText + recentInfo;
      
      let tableHTML = '<table class="data-table"><tr>';
      
      // Add headers
      if (data.data && data.data.length > 0) {
        const firstRow = data.data[0];
        Object.keys(firstRow).forEach(key => {
          if (key !== 'recently_updated') { // Hide internal flag
            tableHTML += `<th>${key}</th>`;
          }
        });
        tableHTML += '</tr>';
        
        // Add rows with highlighting for recent updates
        data.data.forEach(row => {
          const isRecentlyUpdated = row.recently_updated;
          const rowClass = isRecentlyUpdated ? ' class="recently-updated"' : '';
          const title = isRecentlyUpdated ? ' title="Recently updated record"' : '';
          
          tableHTML += `<tr${rowClass}${title}>`;
          Object.entries(row).forEach(([key, value]) => {
            if (key !== 'recently_updated') { // Hide internal flag
              tableHTML += `<td>${value}</td>`;
            }
          });
          tableHTML += '</tr>';
        });
      } else {
        tableHTML += '<tr><td colspan="100%" style="text-align: center; color: #888;">No data found</td></tr>';
      }
      
      tableHTML += '</table>';
      tableDiv.innerHTML = tableHTML;
      modal.style.display = 'block';
    };

    window.closeDataModal = function() {
      document.getElementById('dataModal').style.display = 'none';
    };
    
    // Function to refresh data with current filter
    window.refreshDataWithFilter = async function() {
      if (!window.currentModalNode) return;
      
      const filterSelect = document.getElementById('dataFilter');
      const transIdInput = document.getElementById('transIdInput');
      const filter = filterSelect.value;
      
      // Show/hide trans ID input based on filter
      transIdInput.style.display = filter === 'by_trans_id' ? 'block' : 'none';
      
      try {
        // Build additional parameters
        const params = {
          filter: filter,
          table: 'trans'
        };
        
        if (filter === 'by_trans_id' && transIdInput.value) {
          params.trans_id = transIdInput.value;
        }
        
        // Fetch filtered data using the imported API client
        const response = await apiClient.get(`/data/${window.currentModalNode}`, { params });
        const data = response.data;
        
        // Update modal with new data
        window.showDataModal(window.currentModalNode, data);
        
      } catch (error) {
        console.error('Error refreshing data:', error);
        const statusDiv = document.getElementById('dataStatus');
        statusDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
      }
    };
    
    // Handle filter change to show/hide trans ID input
    document.addEventListener('DOMContentLoaded', function() {
      const filterSelect = document.getElementById('dataFilter');
      const transIdInput = document.getElementById('transIdInput');
      
      if (filterSelect) {
        filterSelect.addEventListener('change', function() {
          transIdInput.style.display = this.value === 'by_trans_id' ? 'block' : 'none';
        });
      }
    });
  </script>
</body>
</html>
